---
# Add swapfile to Ubuntu
# See:
# 
# https://www.digitalocean.com/community/tutorials/
#     how-to-add-swap-space-on-ubuntu-16-04
#
# Use a block to perform tasks conditionally
# only if /.swapfile is not present
#
- name: Check if /.swapfile exists.
  stat: path=/.swapfile
  register: swapfile
- block:

  - debug:
      msg: 'Add swapfile to Ubuntu'

  # read config, create /.swapfile and make it 600
  - name: Read configuration variables.
    include_vars: ../../provision/global_vars.yml
  - name: Allocate '/.swapfile'.
    command: /usr/bin/fallocate -l {{ SHADOWSOCKS.SWAPFILE_SIZE }} /.swapfile creates=/.swapfile
  - name: Changing permissions of '/.swapfile to 600
    file: dest=/.swapfile mode=600

  # make /.swapfile a swap partition and activate it
  - name: Make '/.swapfile' a swap space.
    command: /sbin/mkswap /.swapfile
  - name: Make '/.swapfile' a swap space.
    command: /sbin/swapon /.swapfile

  # add /.swapfile to /etc/fstab to make it permanent
  - name: Update /etc/fstab to make /.swapfile permanent.
    blockinfile:
      path: /etc/fstab
      block: |
        # make /.swapfile permanent
        /.swapfile none swap sw 0 0

  when: swapfile.stat.exists == False

# adjust swappiness and cached pressure
- name: Copy 101-swappiness.conf to /etc/sysctl.d/ 
  copy:
    src: ../../provision/setup/etc/sysctl.d/101-swappiness.conf
    dest: /etc/sysctl.d/101-swappiness.conf
    mode: 0644
- name: Copy 102-cache-pressure.conf to /etc/sysctl.d/
  copy:
    src: ../../provision/setup/etc/sysctl.d/102-cache-pressure.conf
    dest: /etc/sysctl.d/102-cache-pressure.conf
    mode: 0644

- name: Set swappines to 0.
  command: /sbin/sysctl vm.swappiness=0
- name: Set cache pressure to 20.
  command: /sbin/sysctl vm.vfs_cache_pressure=20

